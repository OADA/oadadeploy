# To change which oada gets bash-completion, set the OADA_HOME env var
# Add bash_completion for all services names (oada and services)
_oada_completions() {
  local COMMANDS cur prev SERVICE_NAMES_CACHE

  COMMANDS="init admin upgrade domain service --help help -h"
  COMMANDS="${COMMANDS} build config create down events exec help images kill logs pause"
  COMMANDS="${COMMANDS} port ps pull push restart rm run scale start stop top unpause up"

  # For 2-word completion, track cur and prev word
  COMPREPLY=()
  cur=${COMP_WORDS[COMP_CWORD]}
  prev=${COMP_WORDS[COMP_CWORD-1]}

  # Figure out service names from each service's docker-compose: cached in .oada/service-names
  SERVICE_NAMES_CACHE="#{OADA_HOME}/.oada/service-names"
  SERVICES=""
  # If there is no docker-compose, we have no service names to compute
  if [ -f "${OADA_HOME}/docker-compose.yml" ]; then
    # If we have a docker-compose, and the service names cache is older than it, refresh the cache:
    # -ot means "older than"
    if [ ! -f "$SERVICE_NAMES_CACHE" || "$SERVICE_NAMES_CACHE" -ot "${OADA_HOME}/docker-compose.yml" ]; then
      docker-compose config --services > "$SERVICE_NAMES_CACHE"
    fi
    SERVICES=$(cat $SERVICE_NAMES_CACHE)
  fi
  # First word (oada):
  if [ $COMP_CWORD -eq 1 ]; then
    COMPREPLY=($(compgen -W "${COMMANDS}" "$cur"))

  # Second word (completion depends on the word)
  elif [ $COMP_CWORD -eq 2 ]; then
    case "$prev" in
      init)
        COMPREPLY=()
      ;;
      admin)
        COMPREPLY=($(compgen -W "useradd extendToken bash" "$cur"))
      ;;
      upgrade)
        COMPREPLY=()
      ;;
      domain)
        COMPREPLY=($(compgen -W "init enable disable" "$cur"))
      ;;
      service)
        COMPREPLY=($(compgen -W "install enable disable upgrade" -- "$cur"))
      ;;
      --help|help|-h)
        COMPREPLY=()
      ;;
      build|config|create|down|events|exec|help|images|kill|logs|pause|port|ps|pull|push|restart|rm|run|scale|start|stop|top|unpause|up) 
        COMPREPLY=($(compgen -W "${SERVICES}" "$cur"))
      ;;
    esac
  
  fi
  return 0
}
# Now register that function for the oada command's completions:
complete -F _oada_completions oada

